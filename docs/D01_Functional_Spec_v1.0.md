機能仕様書（Functional Spec）v1.0

対象：ローカルDevin風 開発代理システム（aiflow-local）

1. 目的

本システムは、既存リポジトリ内でローカル実行される「開発代理ツール」である。利用者が投入した要望（Request）に対し、AIが 計画→反復実装（Step）→テスト→ドキュメント→レポート を代理実行し、利用者は 優先度・スコープ決定 と 総合テスト（受け入れ判断） に集中できる状態を実現する。

2. スコープ
2.1 対象範囲

ローカルブラウザUI（localhost）での Request 管理・実行・確認

requests/*.md をSSOTとして運用（作成・更新・状態管理）

git を用いたブランチ作成・コミット・push（origin）

トークン不要PRモード（push後に PR 作成画面に遷移できる compare URL を提供）

途中停止前提の Step反復 による完走性確保

2.2 対象外（機能として提供しない）

gh CLI 依存（禁止）

GitHub/GitLab API などトークンを要する自動PR作成（禁止）

自動マージ／自動リリース（禁止）

3. 利用者・前提
3.1 利用者（単一ユーザー想定）

監督者（ユーザー）：要望投入、優先度付け、総合テスト、差し戻し

代理実行者（AI）：計画、実装、テスト、ドキュメント、レポート

3.2 前提

リポジトリは git 管理されている

ローカルで npm install（devDependencies推奨）により導入・起動できる

開発対象は原則 PHP/Laravel + MySQL（ただし本Specは言語に依存しない抽象度で記述）

4. コア概念（機能要件の骨格）
4.1 Request（要望）

1要望 = 1ファイル（requests/<id>.md）

Requestは 優先度 と 状態 を持つ

本文は「要望」、AI追記として「Plan」「Report」を持つ

4.2 Step（反復単位）

Requestを完了するための最小実装単位

Stepは 小さな変更 を行い、テスト実行 と コミット により進捗を固定する

AIが長時間で停止しがちな前提を吸収するため、Stepは複数に分割される

4.3 状態（Request State）

queued：待機

running：実行中

needs_input：追加情報待ち（ユーザーの入力が必要）

failed：失敗（自動復旧不能または規定回数超過）

done：完了（push済み、PR導線が提示可能）

状態遷移の厳密定義は別紙（D2）だが、本Specでは画面上の見え方と操作可能性を規定する。

5. 画面仕様（UI機能）
5.1 画面一覧

Backlog（Request一覧）

Request詳細（要望／Plan／Report／実行操作）

Run Log（実行ログ表示：詳細内に統合でも可）

Settings/Doctor（任意：環境チェック）

5.2 Backlog（Request一覧）

表示項目

ID（またはタイトル要約）

優先度（P0/P1/P2/P3 等）

状態（queued/running/needs_input/failed/done）

最終更新（last_run など）

タグ（任意）

実行中インジケータ（running の視認性）

操作

新規Request作成

Requestの編集（優先度、要望本文、タグ）

実行開始（単体実行、またはキュー投入）

並び順：優先度降順→更新順（固定）

5.3 Request詳細

セクション

要望（ユーザー入力の本文）

Plan（AIが生成・追記）

Report（Step実行の履歴・結果）

実行ログ（ストリーミング＋過去ログ参照）

操作（状態別）

queued：Run、編集

running：Stop（中断）、ログ閲覧（追記は不可）

needs_input：入力欄（回答追記）＋ Resume（再開）

failed：Re-run（再実行）、必要なら Reset（queuedに戻す：任意）

done：Open PR（compare URLを開く）、再実行（任意）

5.4 Log表示

実行中はリアルタイム更新（WebSocket等）

実行終了後は runs/.../log.txt 相当を参照して表示できる

重要イベント（Plan生成、Step開始/完了、テスト結果、push完了、PR URL生成）を視認できること

6. Request入力・データ仕様（機能的要件）
6.1 Requestファイル構造（概念）

Frontmatter（id / priority / status / base / branch / pr_url / last_run 等）

本文：最低限「要望」セクションを持つ

AIが「Plan」「Report」を追記する

書式・スキーマの厳密定義は別紙（D3）。本Specでは「UI操作により作成・更新されること」を要求する。

6.2 入力の最小要件

ユーザーが入力するのは原則「要望本文」のみでよい。
受け入れ条件（最低3つ）やテスト観点の補完はAIが行い、必要時のみ needs_input とする。

7. 代理実行フロー（機能としての振る舞い）

本システムは、Requestの実行を以下の機能単位で行う。

7.1 Plan生成（要望→計画）

目的

要望を実行可能な計画に変換し、Stepに分割して「途中停止しても進む」構造を作る

出力（Planとして保存/表示される内容）

目的・背景・制約

受け入れ条件（最低3つ）

Step一覧（Stepごとの目的、Done条件、見込み）

リスク・不明点（あれば）

期待動作

PlanはRequest詳細に表示される

Planが不十分（Stepが粗い、Done条件が曖昧等）な場合、システムは自動的に再生成を試みる
※再生成の判定・基準は別紙（D4/D2）に委譲

7.2 Step反復（実装の完走）

目的

大きな作業を小さく刻み、Stepごとに「テスト＋コミット」で確実に前進を固定する

Stepごとの必須実施

対象変更の実施（小さく）

テスト実行（最低：単体）

コミット作成

Reportへの追記（Step番号・内容・結果）

期待動作

Stepが完了するたびにReportに履歴が積まれる

AIが途中で止まった場合でも、同Stepの継続または分割により実行を継続できる

7.3 テスト実行（ローカル）

必須

単体テストを実行し、成功/失敗を記録する

任意（導入状況に依存）

結合/E2Eテストをローカルで実行し、結果を記録する

未整備の場合は「追加すべきテスト（特に回帰）」をReportで提案し、必要に応じて needs_input を発生させる

7.4 ドキュメント更新

変更が利用者判断や運用に影響する場合、関連ドキュメントを更新する

更新有無と対象をReportに明示する

7.5 Git連携（ghなし）

必須

作業ブランチを用意し、変更はブランチ上で行う

Stepごとにコミットを作る

完了時に push する

トークン不要PRモード

push後に compare URL を生成し、Requestに紐付けてUIから開けるようにする

PRの“作成”自体はユーザーがWeb UIで行う（1クリック想定）

8. エラー・例外時のユーザー体験
8.1 needs_input（追加情報が必要）

発生条件（例）

仕様が曖昧で、実装方針が複数あり選べない

テストデータや前提（ログイン情報、画面遷移、環境差）が不足している

破壊的変更の可能性があり、スコープ確認が必要

UI動作

状態が needs_input になり、質問内容が表示される

ユーザーは回答を追記し、Resumeで再開できる

8.2 failed（失敗）

発生条件（例）

テストが恒常的に落ち、自己修正で収束しない

git操作や依存コマンド不備など環境起因で進めない

ルール違反（危険操作、既定ブランチ変更など）を検知

UI動作

状態が failed になり、最終ログと要約が表示される

Re-runで再実行できる（必要に応じてユーザーが要望や前提を補う）

8.3 stop（中断）

running中にユーザーがStopできる

中断時点までの成果（コミット済み分）が残る

状態は運用ルールに従い failed または queued へ（詳細はD2）

9. レポート要件（監督可能性）

RequestのReportには最低限以下が必要（表示・保存されること）。

何を実現したか（要約）

受け入れ条件ごとの状況（満たした／未達／保留）

Step一覧（Step番号、内容、結果、関連コミット）

実行したテスト（コマンド）と結果

主な変更点（ファイル/機能の要約）

リスク/残課題

次アクション（ユーザーがやる総合テスト観点、PR作成導線）

10. 成果物（システムが生成・更新するもの）

requests/<id>.md（Plan/Report/状態の更新）

runs/<id>/<seq>/...（ログ、Plan出力、Stepログ、テストログ等）

gitブランチ＋コミット履歴

push後の compare URL（UIでOpen可能）

11. 受け入れ基準（機能面）

BacklogでRequest作成・優先度管理・状態表示ができる

Runで代理実行が開始し、ログが確認できる

Planが生成され、受け入れ条件（最低3つ）を含む

Step反復により、途中停止があっても前進し、最終的に done/failed/needs_input に収束する

単体テスト結果と主要ログがReportに残る

done時に push され、PR作成導線（compare URL）が提示される

12. 次ドキュメントへの依存（参照）

D2：状態遷移仕様書（State Machine Spec）

D3：Requestファイル仕様（requests/*.md Spec）

D4：Step Plan仕様（Step Breakdown Spec）

D5：レポート仕様（Report Spec）

D7：API仕様（Local API Contract）

D8：Git運用仕様（Git Workflow Spec）

必要なら、このFunctional Specをベースに、次の D2（状態遷移仕様書） を同じ粒度で即作成します（特に needs_input / failed / stop / rerun の扱いを確定させるのが次の最短手です）。

